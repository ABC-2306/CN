# Install required packages
!pip install diffusers transformers accelerate torch torchvision scipy

import torch
from diffusers import StableDiffusionPipeline
from torchvision.transforms import functional as TF
from torchvision.models import inception_v3
import numpy as np
from scipy import linalg
from PIL import Image

# Load pre-trained Stable Diffusion model uses CLIP
device = "cuda" if torch.cuda.is_available() else "cpu"
pipe = StableDiffusionPipeline.from_pretrained(
    "runwayml/stable-diffusion-v1-5",
    torch_dtype=torch.float16 if device == "cuda" else torch.float32
)
pipe = pipe.to(device)

# Generate images from text prompts
prompts = [
    "a cat sitting on a beach",
    "a futuristic city at sunset",
    "a red sports car in the mountains"
]

generated_images = []
for prompt in prompts:
    image = pipe(prompt, num_inference_steps=30).images[0]
    generated_images.append(image)
    display(image)

# FID Score Calculation
def calculate_fid(real_images, generated_images):
    model = inception_v3(pretrained=True, transform_input=False)
    model.fc = torch.nn.Identity()
    model = model.to(device).eval()

    def get_features(images):
        features = []
        for img in images:
            img_tensor = TF.to_tensor(img.resize((299, 299))).unsqueeze(0).to(device)
            with torch.no_grad():
                feat = model(img_tensor).cpu().numpy()
            features.append(feat)
        return np.vstack(features)

    real_features = get_features(real_images)
    gen_features = get_features(generated_images)

    mu1, sigma1 = real_features.mean(axis=0), np.cov(real_features, rowvar=False)
    mu2, sigma2 = gen_features.mean(axis=0), np.cov(gen_features, rowvar=False)

    diff = mu1 - mu2
    covmean = linalg.sqrtm(sigma1.dot(sigma2))

    if np.iscomplexobj(covmean):
        covmean = covmean.real

    fid = diff.dot(diff) + np.trace(sigma1 + sigma2 - 2 * covmean)
    return fid

# For FID, you need real images. Here's an example with sample images
# Download some real images or use existing ones
sample_real_images = generated_images  # Replace with actual real images

fid_score = calculate_fid(sample_real_images, generated_images)
print(f"FID Score: {fid_score:.2f}")
